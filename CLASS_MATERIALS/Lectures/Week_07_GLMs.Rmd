---
title: "Generalized Linear Models"
author: "Peter Ralph"
date: "Advanced Biological Statistics"
---

```{r setup, include=FALSE}
fig.dim <- 5
knitr::opts_chunk$set(fig.width=2*fig.dim,
                      fig.height=fig.dim,
                      fig.align='center')
set.seed(23)
library(tidyverse)
library(rstan)
library(brms)
library(bayesplot)
library(matrixStats)
options(mc.cores = parallel::detectCores())
```

# Notation note

## Matrix multiplication

If 

- $b$ is a $k$-vector
- $X$ is an $n \times k$ matrix

then "$X b$" is shorthand for the $n$-vector
$$ (Xb)_i = \sum_{j=1}^k X_{ij} b_j . $$

. . .

- In R, we use `%*%`.

## Example

Let's say we want to predict
apple `yield` using `leaf_area`, `tree_age`, and `fertilizer`:
$$\begin{aligned}
\text{yield}_i &= \beta_0 + \beta_1 \times \text{leaf\_area}_i \\
    &\qquad {} + \beta_2 \times \text{tree\_age}_i
    + \beta_3 \times \text{fertilizer}_i + \epsilon_i.
\end{aligned}$$

. . .

If we set the columns of $X$ to be

1. all 1s
2. `leaf_area`
3. `tree_age`
4. `fertilizer`

. . .

and $\beta = (\beta_0, \beta_1, \beta_2, \beta_3),$
then this is
$$
\text{yield}_i = (X \beta)_i + \epsilon_i .
$$

##

Or,
$$
  \text{yield} = X \beta + \epsilon .
$$

. . .

Recall
the `model.matrix( )` function gives you back an `X` matrix appropriate for *factors* as well.

# Generalized Linear Models

## Ingredients of a GLM:

1. A probability distribution, $Y$.

  > *(the "family"; describes the output)*

2. A linear predictor, $X \beta$.

  > *(connects input to output)*

3. A link function (usually, $h(\E[Y]) = X\beta$).

  > *(connects linear predictor to probability distribution)*

## Common choices:

- Linear:
  $$ Y \sim \Normal(X \beta, \sigma) .$$

- Binomial ("Logistic"):
  $$ Y \sim \Binom(n, \logistic(X\beta)) .$$

- Poisson:
  $$ Y \sim \Poisson(\exp(X\beta)) .$$

- Gamma:
  $$ Y \sim \Gam(\text{scale}=\exp(X\beta)/k, \text{shape}=k) .$$

## Logistic GLM, in R

```
glm(y ~ x, family=binomial)
```

. . .

```
family {stats}

Family objects provide a convenient way to specify the details of the models
used by functions such as glm.

binomial(link = "logit")
gaussian(link = "identity")
Gamma(link = "inverse")
inverse.gaussian(link = "1/mu^2")
poisson(link = "log")

Arguments

link: a specification for the model link function. This can be a
name/expression, a literal character string, a length-one character vector, or
an object of class "link-glm" (such as generated by make.link) provided it is
not specified via one of the standard names given next.

The gaussian family accepts the links (as names) identity, log and inverse; the
binomial family the links logit, probit, cauchit, (corresponding to logistic,
normal and Cauchy CDFs respectively) log and cloglog (complementary log-log);
the Gamma family the links inverse, identity and log; the poisson family the
links log, identity, and sqrt; and the inverse.gaussian family the links
1/mu^2, inverse, identity and log.
```

## 

Note that the link function is the *inverse* of what we'd write down in the model:
for instance, if the mean of the response is the exponential of the linear predictor,
i.e., if
$$
\E[Y] = \exp(X\beta) .
$$
then we have
```
link = "log"
```

. . .

Other inverses:

- `logistic` has inverse `logit`
- `identity` has inverse `identity`
- `x^2` ("squared") has inverse `sqrt`

# Unpacking the logistic GLM

## Simulate data

100 trials, where probability of success depends on $x$:
```{r sim_logistic, fig.width=2*fig.dim}
alpha <- -7; beta <- 1.2
df <- data.frame( x = runif(100, 0, 10) )
df$y <- alpha + beta * df$x
df$p <- 1 / (1 + exp(-df$y))
df$z <- rbinom(100, size=1, prob=df$p)
plot(z ~ x, data=df)
curve(1/(1+exp(-(-7 + 1.2 * x))), 0, 10, col='red', add=TRUE)
```

## `glm()`

```{r run_glm}
zz <- cbind(df$z, 1-df$z)
summary(
    glm_fit <- glm(zz ~ df$x, family='binomial')
)
```

## `brms::brm()`

```{r run_brm, cache=TRUE}
( brm_fit <- brm(z | trials(1) ~ x, family='binomial', data=df) )
```



## brms: posterior distributions

```{r plot_brm, fig.width=2*fig.dim, warning=FALSE, message=FALSE}
mcmc_hist(brm_fit, pars=c("b_Intercept", "b_x")) + geom_vline(data=data.frame(Parameter=c("b_Intercept", "b_x"), x=c(alpha, beta)), aes(xintercept = x), colour='red')
```

# Identify the GLM

## 

::: {.columns}
:::::: {.column width=60%}


$$\begin{aligned}
    Z &\sim \Gam(\text{shape}=1, \text{scale}=\mu) \\
    \mu &=\exp(-\beta_1 X - \beta_2 Y)
\end{aligned}$$

:::
:::::: {.column width=40%}

What is

1. the probability distribution?
  *(describes the output)*

2. the linear predictor?
  *(connects input to output)*

3. the link function?
  *(connects linear predictor to probability distribution)*


**Then,** simulate from it.

:::
::::::
